(()=>{var e={871:(e,n,t)=>{const{clientHeaders:a}=t(805),{boardHeight:r,boardWidth:o,browserDoesntSupportCanvas:i,initCtxLineProps:s,endLine:c,moveLine:d,startLine:l,getImageDataBuffer:g,drawImageDataBuffer:m,clear:u}=t(10);let f,w,p,b,v=!1;const h=(e,{x:n,y:t})=>{const a=new ArrayBuffer(17),r=new DataView(a);r.setUint8(0,e),r.setFloat64(1,n),r.setFloat64(9,t),b.send(a)},D=e=>{const n={};let t,a;switch(e.type){case"touchdown":case"touchmove":t=e.touches[0].pageX,a=e.touches[0].pageY;break;default:t=e.pageX,a=e.pageY}return n.x=(t-w.offsetLeft)*(o/w.offsetWidth),n.y=(a-w.offsetTop)*(r/w.offsetHeight),n},L=e=>{if(v)return;v=!0;const n=D(e);l(p,n),h(a.penDown,n)},y=e=>{if(!v)return;const n=D(e);d(p,n),h(a.penMove,n)},k=()=>{v&&(v=!1,c(p),b.send(new Uint8Array([a.penUp]).buffer))},E=()=>g(p);e.exports={init:()=>(f=document.querySelector("#drawingBoard"),w=document.querySelector("#drawingBoardOuter"),!i(f)&&(p=f.getContext("2d"),w.onmousedown=L,w.onmousemove=y,w.onmouseup=k,w.onmouseout=k,w.ontouchstart=L,w.ontouchend=k,w.ontouchmove=y,w.ontouchcancel=k,s(p),!0)),toDataURL:()=>f.toDataURL(),getImageDataBuffer:E,drawImageDataBuffer:e=>m(p,e),submitDrawing:()=>{b.send(new Uint8Array([a.submitDrawing,...E()]).buffer)},clear:()=>u(p),setSocket:e=>{b=e}}},893:(e,n,t)=>{const{browserDoesntSupportCanvas:a,initCtxLineProps:r,endLine:o,moveLine:i,startLine:s,drawImageDataBuffer:c,clear:d}=t(10);let l,g;e.exports={init:()=>(l=document.querySelector("#streamingBoard"),!a(l)&&(g=l.getContext("2d"),r(g),!0)),startLine:e=>{s(g,e)},moveLine:e=>{i(g,e)},endLine:()=>{o(g)},toDataURL:()=>l.toDataURL(),drawImageDataBuffer:e=>c(g,e),clear:()=>d(g)}},10:e=>{const n=640,t=480,a=(e,{x:n,y:t})=>{e.lineTo(n,t),e.stroke()};e.exports={boardHeight:t,boardWidth:n,browserDoesntSupportCanvas:e=>!(e.getContext&&e.getContext("2d")&&e.toDataURL&&e.toDataURL()),initCtxLineProps:e=>{e.lineWidth=3,e.strokeStyle="black",e.lineCap="round",e.lineJoin="round"},endLine:e=>{e.closePath()},moveLine:a,startLine:(e,{x:n,y:t})=>{e.beginPath(),e.moveTo(n,t),a(e,{x:n,y:t})},getImageDataBuffer:e=>e.getImageData(0,0,n,t).data,drawImageDataBuffer:(e,a)=>{e.putImageData(new ImageData(new Uint8ClampedArray(a),n,t),0,0)},clear:e=>{const a=e.fillStyle;e.fillStyle="white",e.fillRect(0,0,n,t),e.fillStyle=a}}},38:e=>{e.exports={otherOfTwoPlayers:e=>0===e?1:0}},308:e=>{const n="ABCDEFGHIJKLMNOPQRSTUVWXYZ";e.exports={makeNewCode:e=>{let t;do{t="";for(let e=0;e<3;e++)t+=n[Math.floor(26*Math.random())]}while(e&&e[t]);return t},validateCode:(e,t,a)=>{if(!e)return"No game code specified.";const r=e.length;for(let t=0;t<r;t++){const a=e[t];if(!n.includes(a))return"Invalid game code character(s)."}if(3!==r)return"Invalid game code length.";if(t){if(!t[e])return`No game with code ${e} has been created.`;if(a&&0!==t[e].state)return`The game with code ${e} is already in progress.`}return null}}},805:e=>{e.exports={clientHeaders:{newGame:0,joinGame:1,submitDrawing:2,penDown:3,penMove:4,penUp:5,updateReady:6},serverHeaders:{errorMsg:0,newGameCreated:1,gameStarting:2,drawingDone:3,penDown:4,penMove:5,penUp:6}}}},n={};function t(a){var r=n[a];if(void 0!==r)return r.exports;var o=n[a]={exports:{}};return e[a](o,o.exports,t),o.exports}const a=t(308),r=t(871),o=t(893),{clientHeaders:i,serverHeaders:s}=t(805),{otherOfTwoPlayers:c}=t(38),d=window.origin.replace(/^http/,"ws");let l,g,m={},u={};const f=e=>{const n=new DataView(e),t=n.getUint8(0),a={header:t};switch(t){case s.errorMsg:case s.newGameCreated:case s.aiGenerationDone:a.string=String.fromCharCode(...new Uint8Array(e).slice(1));break;case s.gameStarting:a.round=n.getUint8(1),a.whoScribbles=n.getUint8(2);break;case s.penDown:case s.penMove:a.player=n.getUint8(1),a.mouse={x:n.getFloat64(2),y:n.getFloat64(10)};break;case s.penUp:a.player=n.getUint8(1);break;case s.drawingDone:a.player=n.getUint8(1),a.imageDataBuffer=e.slice(2)}return a},w=(e,n)=>{const t=n||(e=>e),a={};for(let n=0;n<e.length;n++){const r=e[n];a[r]=document.querySelector(`#${t(r)}`)}return a},p=e=>{m[e]&&Object.keys(m).forEach((n=>{console.log(n),m[n].classList.toggle("activeScreen",n===e)}))},b=(e,n,t,a,d)=>{const m=c(a),w=()=>{u.finalScribble.src=l,u.finalExpension.src=g,u.saveDrawingsButton.onclick=()=>{(e=>{const n=t=>{if(t>=e.length)return;const a=e[t],r=document.createElement("a");r.href=a.url,r.target="_blank","download"in r&&(r.download=a.filename),(document.body||document.documentElement).appendChild(r),r.click(),r.remove(),setTimeout((()=>n(t+1)),500)};n(0)})([{url:l,filename:`expensiongame_${e}_round${t+1}_1`},{url:g,filename:`expensiongame_${e}_round${t+1}_2`}])},p("done");const a=t=>{const r=f(t.data);r.header===s.gameStarting&&(n.removeEventListener("message",a),b(e,n,r.round,r.whoScribbles,d))};n.addEventListener("message",a)};if(u.finalScribble.classList.remove("finalDrawingActive"),u.finalExpension.classList.add("finalDrawingActive"),u.finalScribbleOrExpension.checked=!0,u.playAgainCheckbox.checked=!1,l=void 0,g=void 0,u.whyAmIWaiting.innerHTML="Waiting for the other player to make a scribble...",u.whatAmIDrawing.innerHTML="Make a scribble!",o.clear(),r.clear(),u.playAgainCheckbox.onclick=e=>{n.send(new Uint8Array([i.updateReady,e.target.checked?1:0]).buffer)},a===d)p("drawing"),u.submitDrawingButton.onclick=()=>{l=r.toDataURL(),o.drawImageDataBuffer(r.getImageDataBuffer()),r.submitDrawing(),u.whyAmIWaiting.innerHTML="Waiting for the other player to make an exPENsion of your scribble...",p("waitingForDrawing");const e=t=>{const a=f(t.data);if(a.player===m)switch(a.header){case s.penDown:o.startLine(a.mouse);break;case s.penMove:o.moveLine(a.mouse);break;case s.penUp:o.endLine();break;case s.drawingDone:n.removeEventListener("message",e),o.drawImageDataBuffer(a.imageDataBuffer),g=o.toDataURL(),w()}};n.addEventListener("message",e)};else{p("waitingForDrawing");const e=t=>{const i=f(t.data);if(i.player===a)switch(i.header){case s.penDown:o.startLine(i.mouse);break;case s.penMove:o.moveLine(i.mouse);break;case s.penUp:o.endLine();break;case s.drawingDone:n.removeEventListener("message",e),r.drawImageDataBuffer(i.imageDataBuffer),l=r.toDataURL(),u.submitDrawingButton.onclick=()=>{g=r.toDataURL(),r.submitDrawing(),w()},u.whatAmIDrawing.innerHTML="It's exPENsion time! Turn this scribble into a coherent drawing!",p("drawing")}};n.addEventListener("message",e)}};window.onload=()=>{m=w(["start","displayCode","inputCode","waitingForDrawing","drawing","done","noCanvas"],(e=>`${e}Screen`)),u=w(["newGameButton","newGameError","joinGameButton","codeDisplay","codeInput","submitJoinCodeButton","joinError","whyAmIWaiting","whatAmIDrawing","submitDrawingButton","finalScribble","finalExpension","finalScribbleOrExpension","saveDrawingsButton","playAgainCheckbox"]),r.init()&&o.init()||p("noCanvas");const e=e=>{u.newGameButton.disabled=e,u.joinGameButton.disabled=e,u.submitJoinCodeButton.disabled=e,u.codeInput.disabled=e},n=()=>{e(!1),p("start"),u.newGameError.innerHTML="Connection lost."};u.newGameButton.onclick=async()=>{u.newGameError.innerHTML="",e(!0);const t=new WebSocket(d);t.binaryType="arraybuffer",t.addEventListener("open",(()=>{t.send(new Uint8Array([i.newGame]).buffer)})),t.addEventListener("close",n),r.setSocket(t);const a=r=>{const o=f(r.data),{header:i}=o;if(t.removeEventListener("message",a),i===s.errorMsg)e(!1),u.newGameError.innerHTML=o.string,t.removeEventListener("close",n),t.close();else if(i===s.newGameCreated){const e=o.string;u.codeDisplay.innerHTML=e,p("displayCode");const n=a=>{const r=f(a.data);t.removeEventListener("message",n),b(e,t,r.round,r.whoScribbles,0)};t.addEventListener("message",n)}};t.addEventListener("message",a)},u.joinGameButton.onclick=()=>p("inputCode");const t=async()=>{u.joinError.innerHTML="",e(!0);const t=u.codeInput.value.toUpperCase(),o=a.validateCode(t);if(o)e(!1),u.joinError.innerHTML=o.message;else{const a=new WebSocket(d);a.binaryType="arraybuffer",a.addEventListener("open",(()=>{a.send(((e,[...n])=>new Uint8Array([e,...n.map((e=>e.charCodeAt(0)))]).buffer)(i.joinGame,t))})),a.addEventListener("close",n),r.setSocket(a);const o=r=>{const i=f(r.data),{header:c}=i;a.removeEventListener("message",o),c===s.errorMsg?(e(!1),u.joinError.innerHTML=i.string,a.removeEventListener("close",n),a.close()):c===s.gameStarting&&(u.codeInput.value="",b(t,a,i.round,i.whoScribbles,1))};a.addEventListener("message",o)}};u.submitJoinCodeButton.onclick=t,u.codeInput.onkeypress=e=>{"Enter"===(e.code||e.key)&&t()},u.finalScribbleOrExpension.onclick=e=>{const n=e.target.checked;u.finalScribble.classList[n?"remove":"add"]("finalDrawingActive"),u.finalExpension.classList[n?"add":"remove"]("finalDrawingActive")}}})();